<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Resource Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h1 {
            color: #333;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #4caf50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .metric-value {
            font-size: 36px;
            font-weight: bold;
            margin: 10px 0;
        }

        .metric-label {
            font-size: 14px;
            color: #666;
        }

        .chart-container {
            position: relative;
            height: 250px;
            margin-top: 15px;
        }

        .gauge-container {
            position: relative;
            height: 180px;
        }

        .cpu { color: #ff6384; }
        .memory { color: #36a2eb; }
        .disk { color: #ffce56; }
        .network { color: #4bc0c0; }

        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            padding: 15px;
            border-radius: 5px;
            color: #c33;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        .footer {
            text-align: center;
            color: white;
            margin-top: 20px;
            font-size: 14px;
        }

        .last-update {
            font-size: 12px;
            color: #999;
            margin-top: 10px;
        }

        .alert-item {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
        }

        .alert-critical {
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffeaa7;
        }

        .alert-name {
            font-weight: bold;
            color: #721c24;
        }

        .alert-description {
            font-size: 12px;
            color: #856404;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <span>‚ö°</span> System Resource Monitor
            </h1>
            <div class="status">
                <span class="status-dot"></span>
                <span id="connectionStatus">Connecting to Prometheus...</span>
                <span class="last-update">Last updated: <span id="lastUpdate">--</span></span>
            </div>
        </header>

        <div id="errorContainer"></div>
        <div id="loadingContainer" class="loading">Loading metrics...</div>

        <div id="metricsContainer" style="display: none;">
            <!-- Stat Cards -->
            <div class="grid">
                <div class="card">
                    <h2><span>üñ•Ô∏è</span> CPU Usage</h2>
                    <div class="metric-value cpu" id="cpuValue">--</div>
                    <div class="metric-label">Percentage</div>
                    <div class="gauge-container">
                        <canvas id="cpuGauge"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2><span>üíæ</span> Memory Usage</h2>
                    <div class="metric-value memory" id="memoryValue">--</div>
                    <div class="metric-label">Percentage</div>
                    <div class="gauge-container">
                        <canvas id="memoryGauge"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2><span>üíø</span> Disk Usage (C:)</h2>
                    <div class="metric-value disk" id="diskValue">--</div>
                    <div class="metric-label">Percentage</div>
                    <div class="gauge-container">
                        <canvas id="diskGauge"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2><span>üåê</span> Network</h2>
                    <div class="metric-value network" id="networkValue">--</div>
                    <div class="metric-label">Received (Mbps)</div>
                    <div class="metric-label" style="margin-top: 10px;">
                        Sent: <strong id="networkSent">--</strong> Mbps
                    </div>
                </div>
            </div>

            <!-- Time Series Charts -->
            <div class="grid">
                <div class="card" style="grid-column: span 2;">
                    <h2>CPU & Memory History (Last 5 Minutes)</h2>
                    <div class="chart-container">
                        <canvas id="historyChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid">
                <div class="card">
                    <h2>Network Traffic</h2>
                    <div class="chart-container">
                        <canvas id="networkChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2>üö® Active Alerts</h2>
                    <div id="alertsContainer" style="padding: 10px 0;">
                        <div id="noAlerts" style="color: #4caf50; font-weight: bold;">‚úÖ No active alerts</div>
                        <div id="alertsList"></div>
                    </div>
                </div>

                <div class="card">
                    <h2>System Info</h2>
                    <div style="padding: 10px 0;">
                        <div style="margin: 10px 0;">
                            <strong>Hostname:</strong> <span id="hostname">--</span>
                        </div>
                        <div style="margin: 10px 0;">
                            <strong>Total Memory:</strong> <span id="totalMemory">--</span> GB
                        </div>
                        <div style="margin: 10px 0;">
                            <strong>Total Disk (C:):</strong> <span id="totalDisk">--</span> GB
                        </div>
                        <div style="margin: 10px 0;">
                            <strong>Uptime:</strong> <span id="uptime">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            Powered by Prometheus + Windows Exporter | Auto-refresh: 1s
        </div>
    </div>

    <script>
        const PROMETHEUS_URL = 'http://localhost:9090';
        const REFRESH_INTERVAL = 1000; // 1 second

        let charts = {};
        let historyData = {
            labels: [],
            cpu: [],
            memory: [],
            networkIn: [],
            networkOut: []
        };

        // Initialize charts
        function initCharts() {
            // CPU Gauge
            charts.cpuGauge = new Chart(document.getElementById('cpuGauge'), {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['#ff6384', '#e0e0e0'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    circumference: 180,
                    rotation: 270,
                    cutout: '75%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });

            // Memory Gauge
            charts.memoryGauge = new Chart(document.getElementById('memoryGauge'), {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['#36a2eb', '#e0e0e0'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    circumference: 180,
                    rotation: 270,
                    cutout: '75%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });

            // Disk Gauge
            charts.diskGauge = new Chart(document.getElementById('diskGauge'), {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['#ffce56', '#e0e0e0'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    circumference: 180,
                    rotation: 270,
                    cutout: '75%',
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });

            // History Chart
            charts.history = new Chart(document.getElementById('historyChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'CPU %',
                            data: [],
                            borderColor: '#ff6384',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Memory %',
                            data: [],
                            borderColor: '#36a2eb',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 100 }
                    }
                }
            });

            // Network Chart
            charts.network = new Chart(document.getElementById('networkChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Received (Mbps)',
                            data: [],
                            borderColor: '#4bc0c0',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Sent (Mbps)',
                            data: [],
                            borderColor: '#ff9f40',
                            backgroundColor: 'rgba(255, 159, 64, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Query Prometheus
        async function queryPrometheus(query) {
            try {
                const response = await fetch(`${PROMETHEUS_URL}/api/v1/query?query=${encodeURIComponent(query)}`);
                const data = await response.json();
                if (data.status === 'success' && data.data.result.length > 0) {
                    return parseFloat(data.data.result[0].value[1]);
                }
                return null;
            } catch (error) {
                console.error('Query error:', error);
                return null;
            }
        }

        // Update metrics
        async function updateMetrics() {
            try {
                // CPU Usage
                const cpu = await queryPrometheus('100 - (avg(rate(windows_cpu_time_total{mode="idle"}[1m])) * 100)');
                if (cpu !== null) {
                    document.getElementById('cpuValue').textContent = cpu.toFixed(1) + '%';
                    charts.cpuGauge.data.datasets[0].data = [cpu, 100 - cpu];
                    charts.cpuGauge.update('none');
                }

                // Memory Usage
                const memory = await queryPrometheus('100 - ((windows_memory_available_bytes / windows_memory_physical_total_bytes) * 100)');
                if (memory !== null) {
                    document.getElementById('memoryValue').textContent = memory.toFixed(1) + '%';
                    charts.memoryGauge.data.datasets[0].data = [memory, 100 - memory];
                    charts.memoryGauge.update('none');
                }

                // Disk Usage
                const disk = await queryPrometheus('100 - ((windows_logical_disk_free_bytes{volume="C:"} / windows_logical_disk_size_bytes{volume="C:"}) * 100)');
                if (disk !== null) {
                    document.getElementById('diskValue').textContent = disk.toFixed(1) + '%';
                    charts.diskGauge.data.datasets[0].data = [disk, 100 - disk];
                    charts.diskGauge.update('none');
                }

                // Network
                const networkIn = await queryPrometheus('sum(rate(windows_net_bytes_received_total[1m])) * 8 / 1024 / 1024');
                const networkOut = await queryPrometheus('sum(rate(windows_net_bytes_sent_total[1m])) * 8 / 1024 / 1024');
                if (networkIn !== null) {
                    document.getElementById('networkValue').textContent = networkIn.toFixed(2);
                }
                if (networkOut !== null) {
                    document.getElementById('networkSent').textContent = networkOut.toFixed(2);
                }

                // System Info
                const totalMem = await queryPrometheus('windows_memory_physical_total_bytes / 1024 / 1024 / 1024');
                if (totalMem !== null) {
                    document.getElementById('totalMemory').textContent = totalMem.toFixed(1);
                }

                const totalDisk = await queryPrometheus('windows_logical_disk_size_bytes{volume="C:"} / 1024 / 1024 / 1024');
                if (totalDisk !== null) {
                    document.getElementById('totalDisk').textContent = totalDisk.toFixed(1);
                }

                // Hostname
                try {
                    const hostnameResponse = await fetch(`${PROMETHEUS_URL}/api/v1/query?query=${encodeURIComponent('windows_os_hostname')}`);
                    const hostnameData = await hostnameResponse.json();
                    if (hostnameData.status === 'success' && hostnameData.data.result.length > 0) {
                        document.getElementById('hostname').textContent = hostnameData.data.result[0].metric.hostname || '--';
                    }
                } catch (error) {
                    console.error('Hostname query error:', error);
                }

                // Uptime calculation
                const bootTime = await queryPrometheus('windows_system_boot_time_timestamp');
                if (bootTime !== null) {
                    const uptimeSeconds = Date.now() / 1000 - bootTime;
                    const days = Math.floor(uptimeSeconds / 86400);
                    const hours = Math.floor((uptimeSeconds % 86400) / 3600);
                    const minutes = Math.floor((uptimeSeconds % 3600) / 60);
                    document.getElementById('uptime').textContent = `${days}d ${hours}h ${minutes}m`;
                }

                // Update history
                const now = new Date().toLocaleTimeString();
                historyData.labels.push(now);
                historyData.cpu.push(cpu);
                historyData.memory.push(memory);
                historyData.networkIn.push(networkIn);
                historyData.networkOut.push(networkOut);

                // Keep only last 20 data points
                if (historyData.labels.length > 20) {
                    historyData.labels.shift();
                    historyData.cpu.shift();
                    historyData.memory.shift();
                    historyData.networkIn.shift();
                    historyData.networkOut.shift();
                }

                // Update charts
                charts.history.data.labels = historyData.labels;
                charts.history.data.datasets[0].data = historyData.cpu;
                charts.history.data.datasets[1].data = historyData.memory;
                charts.history.update('none');

                charts.network.data.labels = historyData.labels;
                charts.network.data.datasets[0].data = historyData.networkIn;
                charts.network.data.datasets[1].data = historyData.networkOut;
                charts.network.update('none');

                // Update alerts
                await updateAlerts();

                // Update status
                document.getElementById('connectionStatus').textContent = 'Connected to Prometheus';
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                document.getElementById('loadingContainer').style.display = 'none';
                document.getElementById('metricsContainer').style.display = 'block';

            } catch (error) {
                showError('Failed to fetch metrics. Is Prometheus running on http://localhost:9090?');
                console.error(error);
            }
        }

        // Update alerts
        async function updateAlerts() {
            try {
                const response = await fetch(`${PROMETHEUS_URL}/api/v1/alerts`);
                const data = await response.json();
                
                const alertsList = document.getElementById('alertsList');
                const noAlerts = document.getElementById('noAlerts');
                
                if (data.status === 'success' && data.data.alerts.length > 0) {
                    noAlerts.style.display = 'none';
                    alertsList.innerHTML = '';
                    
                    data.data.alerts.forEach(alert => {
                        const alertDiv = document.createElement('div');
                        const severity = alert.labels.severity || 'warning';
                        alertDiv.className = `alert-item alert-${severity}`;
                        
                        alertDiv.innerHTML = `
                            <div class="alert-name">${alert.labels.alertname}</div>
                            <div class="alert-description">${alert.annotations.summary || alert.annotations.description || 'No description'}</div>
                            <div style="font-size: 11px; color: #666; margin-top: 3px;">Status: ${alert.state.toUpperCase()}</div>
                        `;
                        
                        alertsList.appendChild(alertDiv);
                    });
                } else {
                    noAlerts.style.display = 'block';
                    alertsList.innerHTML = '';
                }
            } catch (error) {
                console.error('Failed to fetch alerts:', error);
            }
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<div class="error-message">‚ö†Ô∏è ${message}</div>`;
            document.getElementById('connectionStatus').textContent = 'Connection Error';
        }

        // Initialize
        initCharts();
        updateMetrics();
        setInterval(updateMetrics, REFRESH_INTERVAL);
    </script>
</body>
</html>